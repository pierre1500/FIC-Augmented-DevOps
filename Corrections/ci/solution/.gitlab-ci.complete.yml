# =============================================================================
# GitLab CI Pipeline - Version Complète (Solution)
# =============================================================================
# Pipeline CI/CD complète avec bonnes pratiques
# =============================================================================

stages:
  - build
  - test
  - security
  - docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Images
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend

# =============================================================================
# Cache global pour Maven
# =============================================================================
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - frontend/node_modules/

# =============================================================================
# Stage: Build
# =============================================================================
build-backend:
  stage: build
  image: eclipse-temurin:17-jdk-alpine
  script:
    - cd backend
    - ./mvnw clean compile -B
  artifacts:
    paths:
      - backend/target/
    expire_in: 1 hour
  rules:
    - changes:
        - backend/**/*

build-frontend:
  stage: build
  image: node:21-alpine
  script:
    - cd frontend
    - npm ci --legacy-peer-deps
    - npm run build -- --configuration=production
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour
  rules:
    - changes:
        - frontend/**/*

# =============================================================================
# Stage: Test
# =============================================================================
test-backend:
  stage: test
  image: eclipse-temurin:17-jdk-alpine
  script:
    - cd backend
    - ./mvnw test -B
  artifacts:
    when: always
    reports:
      junit: backend/target/surefire-reports/TEST-*.xml
    paths:
      - backend/target/surefire-reports/
  coverage: '/Total.*?([0-9]{1,3})%/'
  rules:
    - changes:
        - backend/**/*

test-frontend:
  stage: test
  image: node:21-alpine
  script:
    - cd frontend
    - npm ci --legacy-peer-deps
    - npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage
  artifacts:
    when: always
    paths:
      - frontend/coverage/
  coverage: '/Statements\s*:\s*([0-9.]+)%/'
  rules:
    - changes:
        - frontend/**/*
  allow_failure: true

# =============================================================================
# Stage: Security Scanning
# =============================================================================
dependency-check:
  stage: security
  image: eclipse-temurin:17-jdk-alpine
  script:
    - cd backend
    - ./mvnw org.owasp:dependency-check-maven:check -B
  artifacts:
    paths:
      - backend/target/dependency-check-report.html
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# Stage: Docker Build & Push
# =============================================================================
docker-backend:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f docker/backend/Dockerfile.clean -t $BACKEND_IMAGE:$CI_COMMIT_SHA -t $BACKEND_IMAGE:latest backend/
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHA
    - docker push $BACKEND_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - backend/**/*
        - docker/backend/**/*

docker-frontend:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f docker/frontend/Dockerfile.clean -t $FRONTEND_IMAGE:$CI_COMMIT_SHA -t $FRONTEND_IMAGE:latest frontend/
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHA
    - docker push $FRONTEND_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - frontend/**/*
        - docker/frontend/**/*

# =============================================================================
# Stage: Deploy
# =============================================================================
deploy-staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config set-cluster k8s --server="$KUBE_URL" --insecure-skip-tls-verify=true
    - kubectl config set-credentials gitlab --token="$KUBE_TOKEN"
    - kubectl config set-context default --cluster=k8s --user=gitlab
    - kubectl config use-context default
    - kubectl apply -f kubernetes/solution/ -n shopping-staging
    - kubectl set image deployment/shopping-backend backend=$BACKEND_IMAGE:$CI_COMMIT_SHA -n shopping-staging
    - kubectl set image deployment/shopping-frontend frontend=$FRONTEND_IMAGE:$CI_COMMIT_SHA -n shopping-staging
    - kubectl rollout status deployment/shopping-backend -n shopping-staging --timeout=300s
    - kubectl rollout status deployment/shopping-frontend -n shopping-staging --timeout=300s
  environment:
    name: staging
    url: https://staging.shopping.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual

deploy-production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config set-cluster k8s --server="$KUBE_URL" --insecure-skip-tls-verify=true
    - kubectl config set-credentials gitlab --token="$KUBE_TOKEN"
    - kubectl config set-context default --cluster=k8s --user=gitlab
    - kubectl config use-context default
    - kubectl apply -f kubernetes/solution/ -n shopping-prod
    - kubectl set image deployment/shopping-backend backend=$BACKEND_IMAGE:$CI_COMMIT_SHA -n shopping-prod
    - kubectl set image deployment/shopping-frontend frontend=$FRONTEND_IMAGE:$CI_COMMIT_SHA -n shopping-prod
    - kubectl rollout status deployment/shopping-backend -n shopping-prod --timeout=300s
    - kubectl rollout status deployment/shopping-frontend -n shopping-prod --timeout=300s
  environment:
    name: production
    url: https://shopping.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  needs:
    - deploy-staging
